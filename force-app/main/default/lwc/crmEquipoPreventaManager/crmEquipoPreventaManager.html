<template>
  <lightning-card title="Equipo Preventa" icon-name="utility:groups">
    <div class="slds-p-horizontal_medium component-container">
      <div class="card-actions">
        <template if:true={canEdit}>
          <lightning-button 
            label="Añadir miembro" 
            variant="brand"
            icon-name="utility:add"
            onclick={openSearch}
            disabled={isLoading}>
          </lightning-button>
        </template>
        <template if:true={canEdit}>
          <lightning-button 
            variant="success" 
            label="Guardar cambios" 
            icon-name="utility:save"
            onclick={save} 
            class="slds-m-left_x-small" 
            disabled={disableSaveButton}>
          </lightning-button>
        </template>
        <lightning-button 
          label="Refrescar" 
          icon-name="utility:refresh"
          onclick={refreshPermisos} 
          class="slds-m-left_x-small"
          disabled={isLoading}>
        </lightning-button>
      </div>
      
      <template if:true={visibleRows}>
        <div class="team-table-container">
          <lightning-datatable 
            key-field="key" 
            data={visibleRows} 
            columns={columns} 
            onrowaction={handleRowAction}
            oncellchange={handleCellChange}
            hide-checkbox-column
            show-row-number-column>
          </lightning-datatable>
        </div>
      </template>
      
      <template if:false={visibleRows}>
        <div class="empty-state">
          <lightning-icon icon-name="utility:groups" size="large" class="empty-icon"></lightning-icon>
          <h3 class="slds-text-heading_small slds-m-top_small">No hay miembros en el equipo</h3>
          <p class="slds-text-body_regular slds-text-color_weak">Comienza añadiendo el primer miembro del equipo de preventa</p>
        </div>
      </template>
      
      <!-- Loading overlay que cubre todo el componente -->
      <template if:true={isLoading}>
        <div class="loading-overlay">
          <lightning-spinner alternative-text="Procesando..." size="medium"></lightning-spinner>
        </div>
      </template>
    </div>
  </lightning-card>

  <!-- Modal búsqueda y alta uno a uno -->
  <template if:true={showSearch}>
    <section role="dialog" class="slds-modal slds-fade-in-open">
      <div class="slds-modal__container">
        <header class="slds-modal__header">
          <h2 class="slds-text-heading_medium">Buscar Empleado</h2>
        </header>
        <div class="slds-modal__content slds-p-around_small">
          <div class="search-filters-container">
            <h3 class="slds-text-heading_small slds-m-bottom_medium">Filtros de búsqueda</h3>
            <div class="slds-grid slds-wrap slds-gutters">
              <div class="slds-col slds-size_1-of-2">
                <lightning-input 
                  class="search-input" 
                  label="Código Empleado" 
                  value={filtro.codigo} 
                  data-field="codigo" 
                  onchange={handleFiltro}
                  placeholder="Ingrese código..."
                  variant="label-stacked">
                </lightning-input>
              </div>
              <div class="slds-col slds-size_1-of-2">
                <lightning-input 
                  class="search-input" 
                  label="Nombre" 
                  value={filtro.nombre} 
                  data-field="nombre" 
                  onchange={handleFiltro}
                  placeholder="Ingrese nombre..."
                  variant="label-stacked">
                </lightning-input>
              </div>
              <div class="slds-col slds-size_1-of-2">
                <lightning-input 
                  class="search-input" 
                  label="Primer Apellido" 
                  value={filtro.apellido1} 
                  data-field="apellido1" 
                  onchange={handleFiltro}
                  placeholder="Ingrese primer apellido..."
                  variant="label-stacked">
                </lightning-input>
              </div>
              <div class="slds-col slds-size_1-of-2">
                <lightning-input 
                  class="search-input" 
                  label="Segundo Apellido" 
                  value={filtro.apellido2} 
                  data-field="apellido2" 
                  onchange={handleFiltro}
                  placeholder="Ingrese segundo apellido..."
                  variant="label-stacked">
                </lightning-input>
              </div>
            </div>
            <div class="search-actions">
              <lightning-button 
                variant="brand" 
                label="Buscar Empleados" 
                icon-name="utility:search"
                onclick={buscar} 
                class="search-button">
              </lightning-button>
              <lightning-button 
                variant="neutral" 
                label="Limpiar filtros" 
                icon-name="utility:clear"
                onclick={limpiarFiltros} 
                class="slds-m-left_small">
              </lightning-button>
            </div>
          </div>
          <!-- Lista solo si hay resultados y NO hay empleado seleccionado -->
          <template if:true={showResultadosList}>
            <div class="slds-m-top_small">
              <div class="slds-box slds-theme_shade search-results">
                <h3 class="slds-text-heading_small slds-m-bottom_small">Resultados de búsqueda</h3>
                <div class="results-container">
                  <template for:each={resultados} for:item="emp">
                    <article key={emp.codigo} class="employee-card">
                      <div class="employee-info">
                        <div class="employee-name">{emp.nombreCompleto}</div>
                        <div class="employee-details">
                          <span class="detail-item">
                            <lightning-icon icon-name="utility:email" size="xx-small"></lightning-icon>
                            {emp.correo}
                          </span>
                          <span class="detail-item">
                            <lightning-icon icon-name="utility:number_input" size="xx-small"></lightning-icon>
                            {emp.codigo}
                          </span>
                        </div>
                      </div>
                      <div class="employee-actions">
                        <lightning-button 
                          variant="brand" 
                          label="Seleccionar" 
                          size="small"
                          data-cod={emp.codigo} 
                          data-nombre={emp.nombreCompleto} 
                          data-correo={emp.correo}
                          data-mercantil={emp.mercantilMapeado}
                          onclick={seleccionarEmpleado}>
                        </lightning-button>
                      </div>
                    </article>
                  </template>
                </div>
              </div>
            </div>
          </template>

          <!-- Formulario de alta para el empleado seleccionado -->
          <template if:true={selectedEmpleado}>
            <div class="slds-m-top_medium selected-employee-form" data-id="formNuevoRegistro">
              <div class="form-header">
                <div class="form-title">
                  <lightning-icon icon-name="utility:add" size="small" class="slds-m-right_x-small"></lightning-icon>
                  <span class="slds-text-heading_small">Nuevo registro de equipo</span>
                </div>
                <lightning-button 
                  label="Cambiar empleado" 
                  variant="neutral" 
                  size="small"
                  icon-name="utility:change_record_type"
                  onclick={deselectEmpleado}>
                </lightning-button>
              </div>
              
              <div class="employee-summary">
                <div class="summary-item">
                  <span class="summary-label">Empleado seleccionado:</span>
                  <span class="summary-value">{selectedEmpleado.nombreCompleto}</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Código de empleado:</span>
                  <span class="summary-value">{selectedEmpleado.codigo}</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Email:</span>
                  <span class="summary-value">{selectedEmpleado.correo}</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Sociedad asignada:</span>
                  <span class="summary-value">{selectedEmpleado.mercantilMapeado}</span>
                </div>
              </div>

              <div class="form-fields">
                <lightning-input 
                  class="slds-m-bottom_small" 
                  type="number" 
                  label="Horas estimadas" 
                  value={horasSeleccion} 
                  onchange={handleHoras}
                  min="0"
                  step="0.5"
                  required>
                </lightning-input>
              </div>

              <div class="form-actions">
                <lightning-button 
                  variant="brand" 
                  label="Agregar al equipo" 
                  icon-name="utility:add"
                  onclick={agregarSeleccionadoConValidacion} 
                  disabled={disableAgregar}>
                </lightning-button>
              </div>
            </div>
          </template>
        </div>
        <footer class="slds-modal__footer">
          <lightning-button label="Cerrar" onclick={closeSearch}></lightning-button>
        </footer>
      </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
  </template>
</template>